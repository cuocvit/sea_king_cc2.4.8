{"version":3,"sources":["assets\\mail\\scripts\\Mail.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,qEAA2D;AAC3D,mEAAkE;AAClE,+DAA8D;AAC9D,yDAAwD;AACxD,2EAA0E;AAEpE,IAAA,KAAwB,EAAE,CAAC,UAAU,EAAnC,OAAO,aAAA,EAAE,QAAQ,cAAkB,CAAC;AAG5C;IAA0B,wBAAU;IAApC;QAAA,qEAqKC;QAnKW,eAAS,GAAc,IAAI,CAAC;QAG5B,wBAAkB,GAAc,IAAI,CAAC;QAGrC,mBAAa,GAAgB,EAAE,CAAC;QAGhC,mBAAa,GAAa,IAAI,CAAC;QAG/B,gBAAU,GAAY,IAAI,CAAC;QAG3B,qBAAe,GAAa,IAAI,CAAC;QAGjC,oBAAc,GAAc,IAAI,CAAC;QAGjC,qBAAe,GAAc,IAAI,CAAC;QAElC,gBAAU,GAAW,CAAC,CAAC,CAAC;;IA4IpC,CAAC;IA1Ia,uBAAQ,GAAlB;QACI,IAAI,IAAI,CAAC,UAAU,IAAI,CAAC,CAAC,EAAE;YACvB,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC;YACpB,IAAM,aAAa,GAAG,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;YAE1D,IAAI,CAAC,aAAa,CAAC,SAAS,EAAE;gBAC1B,aAAa,CAAC,KAAK,EAAE,CAAC;gBACtB,aAAa,CAAC,SAAS,GAAG,IAAI,CAAC;aAClC;YAED,IAAI,CAAC,+BAA+B,CAAC,aAAa,CAAC,CAAC;YACpD,gBAAE,CAAC,OAAO,CAAC,cAAc,CAAC,+BAAc,CAAC,GAAG,CAAC,CAAC;YAE9C,IAAI,gBAAE,CAAC,IAAI,CAAC,WAAW,CAAC,cAAc,EAAE;gBACpC,gBAAE,CAAC,IAAI,CAAC,WAAW,CAAC,cAAc,GAAG,KAAK,CAAC;aAC9C;YAED,IAAI,CAAC,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC;SAC5B;IACL,CAAC;IAES,wBAAS,GAAnB;QACI,IAAI,CAAC,aAAa,CAAC,KAAK,EAAE,CAAC;QAC3B,IAAI,CAAC,eAAe,CAAC,KAAK,EAAE,CAAC;QAC7B,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC,CAAC;QACrB,gBAAE,CAAC,OAAO,CAAC,cAAc,CAAC,+BAAc,CAAC,GAAG,CAAC,CAAC;IAClD,CAAC;IAEO,6CAA8B,GAAtC,UAAuC,KAAe;QAAtD,iBA0BC;QAzBG,IAAM,MAAM,GAAG,KAAK,CAAC,MAAM,CAAC;QAC5B,IAAI,MAAM,IAAI,IAAI,CAAC,SAAS,CAAC,IAAI,IAAI,MAAM,IAAI,IAAI,CAAC,kBAAkB,CAAC,IAAI,EAAE;YACzE,gBAAE,CAAC,EAAE,CAAC,iBAAiB,CAAC,gBAAE,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;SAC1C;aAAM,IAAI,MAAM,IAAI,IAAI,CAAC,cAAc,CAAC,IAAI,EAAE;YAC3C,IAAI,gBAAE,CAAC,IAAI,CAAC,cAAc,CAAC,qBAAqB,CAAC,MAAM,GAAG,CAAC,EAAE;gBACzD,IAAI,CAAC,cAAc,CAAC,YAAY,GAAG,KAAK,CAAC;gBACzC,aAAK,CAAC,gBAAgB,CAAC,IAAI,CAAC,cAAc,CAAC,IAAI,EAAE,EAAE,CAAC,MAAM,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;gBACvE,IAAI,CAAC,eAAe,CAAC,YAAY,GAAG,KAAK,CAAC;gBAC1C,aAAK,CAAC,gBAAgB,CAAC,IAAI,CAAC,eAAe,CAAC,IAAI,EAAE,EAAE,CAAC,MAAM,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;gBACxE,IAAI,CAAC,eAAe,CAAC;oBACjB,KAAI,CAAC,sBAAsB,EAAE,CAAC;gBAClC,CAAC,CAAC,CAAC;aACN;SAEJ;aAAM,IAAI,MAAM,IAAI,IAAI,CAAC,eAAe,CAAC,IAAI,EAAE;YAC5C,IAAI,gBAAE,CAAC,IAAI,CAAC,cAAc,CAAC,qBAAqB,CAAC,MAAM,GAAG,CAAC,EAAE;gBACzD,IAAI,CAAC,cAAc,CAAC,YAAY,GAAG,KAAK,CAAC;gBACzC,aAAK,CAAC,gBAAgB,CAAC,IAAI,CAAC,cAAc,CAAC,IAAI,EAAE,EAAE,CAAC,MAAM,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;gBACvE,IAAI,CAAC,eAAe,CAAC,YAAY,GAAG,KAAK,CAAC;gBAC1C,aAAK,CAAC,gBAAgB,CAAC,IAAI,CAAC,eAAe,CAAC,IAAI,EAAE,EAAE,CAAC,MAAM,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;gBACxE,IAAI,CAAC,gBAAgB,CAAC;oBAClB,KAAI,CAAC,sBAAsB,EAAE,CAAC;gBAClC,CAAC,CAAC,CAAC;aACN;SACJ;IACL,CAAC;IAEO,8BAAe,GAAvB,UAAwB,QAAoB;QAA5C,iBAwBC;QAvBG,IAAM,QAAQ,GAAG,gBAAE,CAAC,IAAI,CAAC,cAAc,CAAC,qBAAqB,CAAC;QAC9D,IAAI,CAAC,GAAG,QAAQ,CAAC,MAAM,EAAE;YACrB,IAAM,IAAI,GAAG,QAAQ,CAAC,GAAG,EAAE,CAAC;YAC5B,IAAI,CAAC,IAAI,IAAI,CAAC,SAAS,IAAI,CAAC,IAAI,IAAI,CAAC,aAAa,EAAE;gBAChD,IAAM,MAAM,GAAG,gBAAE,CAAC,IAAI,CAAC,WAAW,CAAC;gBACnC,IAAM,IAAI,GAAG;oBACT,GAAG,EAAE,MAAM,CAAC,GAAG;oBACf,KAAK,EAAE,MAAM,CAAC,KAAK;oBACnB,OAAO,EAAE,IAAI,CAAC,OAAO;oBACrB,SAAS,EAAE,CAAC;oBACZ,aAAa,EAAE,CAAC;iBACnB,CAAC;gBACF,MAAM,CAAC,eAAe,CAAC,UAAC,CAAC;oBACrB,CAAC,CAAC,UAAU,CAAC;oBACb,KAAI,CAAC,eAAe,CAAC,QAAQ,CAAC,CAAC;gBACnC,CAAC,EAAE,IAAI,CAAC,CAAC;aACZ;iBAAM;gBACH,IAAI,CAAC,eAAe,CAAC,QAAQ,CAAC,CAAC;aAClC;SACJ;aAAM;YACH,QAAQ,EAAE,CAAC;SACd;IAEL,CAAC;IAEO,+BAAgB,GAAxB,UAAyB,QAAoB;QAA7C,iBAwBC;QAvBG,IAAM,QAAQ,GAAG,gBAAE,CAAC,IAAI,CAAC,cAAc,CAAC,qBAAqB,CAAC;QAE9D,IAAI,QAAQ,CAAC,MAAM,GAAG,CAAC,EAAE;YACrB,IAAM,IAAI,GAAG,QAAQ,CAAC,GAAG,EAAE,CAAC;YAE5B,IAAI,IAAI,CAAC,SAAS,IAAI,CAAC,IAAI,IAAI,CAAC,aAAa,IAAI,CAAC,EAAE;gBAChD,IAAM,QAAQ,GAAG;oBACb,GAAG,EAAE,gBAAE,CAAC,IAAI,CAAC,WAAW,CAAC,GAAG;oBAC5B,KAAK,EAAE,gBAAE,CAAC,IAAI,CAAC,WAAW,CAAC,KAAK;oBAChC,OAAO,EAAE,IAAI,CAAC,OAAO;oBACrB,SAAS,EAAE,CAAC;oBACZ,aAAa,EAAE,CAAC;iBACnB,CAAC;gBAEF,gBAAE,CAAC,IAAI,CAAC,WAAW,CAAC,eAAe,CAAC;oBAChC,KAAI,CAAC,gBAAgB,CAAC,QAAQ,CAAC,CAAC;gBACpC,CAAC,EAAE,QAAQ,CAAC,CAAC;aAChB;iBAAM;gBACH,IAAI,CAAC,gBAAgB,CAAC,QAAQ,CAAC,CAAC;aACnC;SACJ;aAAM;YACH,QAAQ,EAAE,CAAC;SACd;IACL,CAAC;IAEO,8CAA+B,GAAvC,UAAwC,MAAiB;QACrD,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC,aAAa,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;QACrD,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC;QACvC,IAAI,CAAC,UAAU,CAAC,MAAM,GAAG,KAAK,CAAC;QAC/B,IAAI,IAAI,CAAC,UAAU,KAAK,CAAC,IAAI,IAAI,CAAC,UAAU,KAAK,CAAC,EAAE;YAChD,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC;YACtC,IAAI,CAAC,oBAAoB,EAAE,CAAC;SAC/B;aAAM,IAAI,IAAI,CAAC,UAAU,KAAK,CAAC,EAAE;YAC9B,IAAI,CAAC,UAAU,CAAC,MAAM,GAAG,IAAI,CAAC;YAC9B,IAAI,CAAC,sBAAsB,EAAE,CAAC;SACjC;IACL,CAAC;IAEO,mCAAoB,GAA5B;QAAA,iBAMC;QALG,IAAM,KAAK,GAAG,IAAI,CAAC,UAAU,IAAI,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC;QAC/C,gBAAE,CAAC,IAAI,CAAC,yBAAyB,CAAC,KAAK,EAAE;YACrC,KAAI,CAAC,aAAa,CAAC,OAAO,CAAC,KAAI,CAAC,UAAU,IAAI,CAAC,CAAC,CAAC,CAAC,gBAAE,CAAC,IAAI,CAAC,cAAc,CAAC,2BAA2B,CAAC,CAAC,CAAC,gBAAE,CAAC,IAAI,CAAC,cAAc,CAAC,0BAA0B,CAAC,CAAC;YAC1J,KAAI,CAAC,aAAa,CAAC,WAAW,EAAE,CAAC;QACrC,CAAC,CAAC,CAAC;IACP,CAAC;IAEO,qCAAsB,GAA9B;QAAA,iBAQC;QAPG,gBAAE,CAAC,IAAI,CAAC,qBAAqB,CAAC;YAC1B,KAAI,CAAC,eAAe,CAAC,OAAO,CAAC,gBAAE,CAAC,IAAI,CAAC,cAAc,CAAC,qBAAqB,CAAC,CAAC;YAC3E,KAAI,CAAC,cAAc,CAAC,YAAY,GAAG,gBAAE,CAAC,IAAI,CAAC,cAAc,CAAC,qBAAqB,CAAC,MAAM,GAAG,CAAC,CAAC;YAC3F,aAAK,CAAC,gBAAgB,CAAC,KAAI,CAAC,cAAc,CAAC,IAAI,EAAE,KAAI,CAAC,cAAc,CAAC,YAAY,CAAC,CAAC,CAAC,EAAE,CAAC,MAAM,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,MAAM,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;YACnI,KAAI,CAAC,eAAe,CAAC,YAAY,GAAG,gBAAE,CAAC,IAAI,CAAC,cAAc,CAAC,qBAAqB,CAAC,MAAM,GAAG,CAAC,CAAC;YAC5F,aAAK,CAAC,gBAAgB,CAAC,KAAI,CAAC,eAAe,CAAC,IAAI,EAAE,KAAI,CAAC,eAAe,CAAC,YAAY,CAAC,CAAC,CAAC,EAAE,CAAC,MAAM,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,MAAM,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;QACzI,CAAC,CAAC,CAAC;IACP,CAAC;IAlKD;QADC,QAAQ,CAAC,EAAE,CAAC,MAAM,CAAC;2CACgB;IAGpC;QADC,QAAQ,CAAC,EAAE,CAAC,MAAM,CAAC;oDACyB;IAG7C;QADC,QAAQ,CAAC,CAAC,EAAE,CAAC,MAAM,CAAC,CAAC;+CACkB;IAGxC;QADC,QAAQ,CAAC,mBAAQ,CAAC;+CACoB;IAGvC;QADC,QAAQ,CAAC,EAAE,CAAC,IAAI,CAAC;4CACiB;IAGnC;QADC,QAAQ,CAAC,mBAAQ,CAAC;iDACsB;IAGzC;QADC,QAAQ,CAAC,EAAE,CAAC,MAAM,CAAC;gDACqB;IAGzC;QADC,QAAQ,CAAC,EAAE,CAAC,MAAM,CAAC;iDACsB;IAvBjC,IAAI;QADhB,OAAO;OACK,IAAI,CAqKhB;IAAD,WAAC;CArKD,AAqKC,CArKyB,uBAAU,GAqKnC;AArKY,oBAAI","file":"","sourceRoot":"/","sourcesContent":["import { gm } from '../../start-scene/scripts/GameManager';\r\nimport { GameModule } from '../../start-scene/scripts/GameModule';\r\nimport { ListView } from '../../start-scene/scripts/ListView';\r\nimport { Utils } from '../../start-scene/scripts/Utils';\r\nimport { BANNER_AD_TYPE } from '../../start-scene/scripts/ChannelManager';\r\n\r\nconst { ccclass, property } = cc._decorator;\r\n\r\n@ccclass\r\nexport class Mail extends GameModule {\r\n    @property(cc.Button)\r\n    private close_btn: cc.Button = null;\r\n\r\n    @property(cc.Button)\r\n    private anywhere_close_btn: cc.Button = null;\r\n\r\n    @property([cc.Toggle])\r\n    private tab_tog_array: cc.Toggle[] = [];\r\n\r\n    @property(ListView)\r\n    private mail_log_list: ListView = null;\r\n\r\n    @property(cc.Node)\r\n    private inbox_node: cc.Node = null;\r\n\r\n    @property(ListView)\r\n    private mail_inbox_list: ListView = null;\r\n\r\n    @property(cc.Button)\r\n    private delete_all_btn: cc.Button = null;\r\n\r\n    @property(cc.Button)\r\n    private receive_all_btn: cc.Button = null;\r\n\r\n    private _tab_index: number = -1;\r\n\r\n    protected onEnable(): void {\r\n        if (this._tab_index == -1) {\r\n            this._tab_index = 0;\r\n            const currentToggle = this.tab_tog_array[this._tab_index];\r\n\r\n            if (!currentToggle.isChecked) {\r\n                currentToggle.check();\r\n                currentToggle.isChecked = true;\r\n            }\r\n\r\n            this.editor_on_toggle_change_handler(currentToggle);\r\n            gm.channel.show_banner_ad(BANNER_AD_TYPE.ALL);\r\n\r\n            if (gm.data.server_data.mail_red_point) {\r\n                gm.data.server_data.mail_red_point = false;\r\n            }\r\n\r\n            this.node.active = false;\r\n        }\r\n    }\r\n\r\n    protected onDisable(): void {\r\n        this.mail_log_list.reset();\r\n        this.mail_inbox_list.reset();\r\n        this._tab_index = -1;\r\n        gm.channel.hide_banner_ad(BANNER_AD_TYPE.ALL);\r\n    }\r\n\r\n    private editor_on_button_click_handler(event: cc.Event): void {\r\n        const target = event.target;\r\n        if (target == this.close_btn.node || target == this.anywhere_close_btn.node) {\r\n            gm.ui.async_hide_module(gm.const.Mail);\r\n        } else if (target == this.delete_all_btn.node) {\r\n            if (gm.data.mail_temp_data.mail_inbox_data_array.length > 0) {\r\n                this.delete_all_btn.interactable = false;\r\n                Utils.set_sprite_state(this.delete_all_btn.node, cc.Sprite.State.GRAY);\r\n                this.receive_all_btn.interactable = false;\r\n                Utils.set_sprite_state(this.receive_all_btn.node, cc.Sprite.State.GRAY);\r\n                this.delete_all_mail(() => {\r\n                    this.update_mail_inbox_view();\r\n                });\r\n            }\r\n\r\n        } else if (target == this.receive_all_btn.node) {\r\n            if (gm.data.mail_temp_data.mail_inbox_data_array.length > 0) {\r\n                this.delete_all_btn.interactable = false;\r\n                Utils.set_sprite_state(this.delete_all_btn.node, cc.Sprite.State.GRAY);\r\n                this.receive_all_btn.interactable = false;\r\n                Utils.set_sprite_state(this.receive_all_btn.node, cc.Sprite.State.GRAY);\r\n                this.receive_all_mail(() => {\r\n                    this.update_mail_inbox_view();\r\n                });\r\n            }\r\n        }\r\n    }\r\n\r\n    private delete_all_mail(callback: () => void): void {\r\n        const mailList = gm.data.mail_temp_data.mail_inbox_data_array;\r\n        if (0 < mailList.length) {\r\n            const mail = mailList.pop();\r\n            if (1 == mail.mail_type && 0 != mail.reward_status) {\r\n                const server = gm.data.server_data;\r\n                const data = {\r\n                    uid: server.uid,\r\n                    token: server.token,\r\n                    mail_id: mail.mail_id,\r\n                    op_status: 2,\r\n                    reward_status: 0\r\n                };\r\n                server.op_player_email((t) => {\r\n                    t.ResultCode;\r\n                    this.delete_all_mail(callback);\r\n                }, data);\r\n            } else {\r\n                this.delete_all_mail(callback);\r\n            }\r\n        } else {\r\n            callback();\r\n        }\r\n\r\n    }\r\n\r\n    private receive_all_mail(callback: () => void): void {\r\n        const mailList = gm.data.mail_temp_data.mail_inbox_data_array;\r\n\r\n        if (mailList.length > 0) {\r\n            const mail = mailList.pop();\r\n\r\n            if (mail.mail_type == 1 && mail.reward_status == 0) {\r\n                const mailData = {\r\n                    uid: gm.data.server_data.uid,\r\n                    token: gm.data.server_data.token,\r\n                    mail_id: mail.mail_id,\r\n                    op_status: 0,\r\n                    reward_status: 1,\r\n                };\r\n\r\n                gm.data.server_data.op_player_email(() => {\r\n                    this.receive_all_mail(callback);\r\n                }, mailData);\r\n            } else {\r\n                this.receive_all_mail(callback);\r\n            }\r\n        } else {\r\n            callback();\r\n        }\r\n    }\r\n\r\n    private editor_on_toggle_change_handler(toggle: cc.Toggle): void {\r\n        this._tab_index = this.tab_tog_array.indexOf(toggle);\r\n        this.mail_log_list.node.active = false;\r\n        this.inbox_node.active = false;\r\n        if (this._tab_index === 0 || this._tab_index === 1) {\r\n            this.mail_log_list.node.active = true;\r\n            this.update_mail_log_view();\r\n        } else if (this._tab_index === 2) {\r\n            this.inbox_node.active = true;\r\n            this.update_mail_inbox_view();\r\n        }\r\n    }\r\n\r\n    private update_mail_log_view(): void {\r\n        const index = this._tab_index == 0 ? \"1\" : \"2\";\r\n        gm.data.get_player_fight_log_data(index, () => {\r\n            this.mail_log_list.setData(this._tab_index == 0 ? gm.data.mail_temp_data.mail_defense_log_data_array : gm.data.mail_temp_data.mail_attack_log_data_array);\r\n            this.mail_log_list.scrollToTop();\r\n        });\r\n    }\r\n\r\n    private update_mail_inbox_view(): void {\r\n        gm.data.get_player_email_data(() => {\r\n            this.mail_inbox_list.setData(gm.data.mail_temp_data.mail_inbox_data_array);\r\n            this.delete_all_btn.interactable = gm.data.mail_temp_data.mail_inbox_data_array.length > 0;\r\n            Utils.set_sprite_state(this.delete_all_btn.node, this.delete_all_btn.interactable ? cc.Sprite.State.NORMAL : cc.Sprite.State.GRAY);\r\n            this.receive_all_btn.interactable = gm.data.mail_temp_data.mail_inbox_data_array.length > 0;\r\n            Utils.set_sprite_state(this.receive_all_btn.node, this.receive_all_btn.interactable ? cc.Sprite.State.NORMAL : cc.Sprite.State.GRAY);\r\n        });\r\n    }\r\n}"]}