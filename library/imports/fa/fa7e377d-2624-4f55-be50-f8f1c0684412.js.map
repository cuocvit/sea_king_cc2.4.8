{"version":3,"sources":["assets\\book\\scripts\\NodeBookItem.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import { NodePoolItem } from '../../start-scene/scripts/NodePoolItem';\r\nimport { gm } from '../../start-scene/scripts/GameManager';\r\nimport { BundleName, RewardIdEnum, SetItemNumEnum } from '../../start-scene/scripts/Constants';\r\nimport { Utils } from '../../start-scene/scripts/Utils';\r\nimport SceneBookLogic from './SceneBookLogic';\r\nimport { BookConfig } from '../../common/configs/books';\r\n\r\nconst { ccclass, property } = cc._decorator;\r\n\r\n@ccclass\r\nclass NodeBookItem extends NodePoolItem {\r\n    @property(cc.Sprite)\r\n    private icon: cc.Sprite = null;\r\n\r\n    @property(cc.Node)\r\n    private node_empty: cc.Node = null;\r\n\r\n    @property(cc.Node)\r\n    private node_root: cc.Node = null;\r\n\r\n    @property(cc.Sprite)\r\n    private icon_reward: cc.Sprite = null;\r\n\r\n    @property(cc.Button)\r\n    private btn_click: cc.Button = null;\r\n\r\n    @property({ type: [cc.Node] })\r\n    private color_bgs: cc.Node[] = [];\r\n\r\n    private iItemId: number;\r\n    private iScale: number;\r\n\r\n    private constructor() {\r\n        super();\r\n        this.iItemId = 0;\r\n        this.iScale = 0;\r\n    }\r\n\r\n    protected onLoad(): void { }\r\n\r\n    protected onEnable(): void {\r\n        this.setScale(this.iScale);\r\n    }\r\n\r\n    protected start(): void { }\r\n\r\n    public init(itemId: number, interactable?: boolean): void {\r\n        this.btn_click.interactable = (interactable !== undefined) ? interactable : true;\r\n        if (itemId <= 0) return;\r\n        this.iItemId = itemId;\r\n        const logic = gm.ui.get_module(gm.const.BOOK).getLogic();\r\n        const delayCd = logic.getDelayCd(itemId);\r\n        const configData = gm.config.get_row_data(\"BookConfigData\", itemId.toString()) as BookConfig;\r\n\r\n        this.node_root.active = true;\r\n        const isUnlock = logic.checkIsUnlock(itemId);\r\n        const hasUnlockReward = gm.data.mapCell_data.checkBookItemHaveUnlockReward(itemId);\r\n        let hasReward: boolean = configData.reward > 0 && isUnlock && hasUnlockReward;\r\n\r\n        let isHeroType = false;\r\n        if (!(isHeroType = [SceneBookLogic.SUB_TYPE_HERO, SceneBookLogic.SUB_TYPE_SUPER_HERO, SceneBookLogic.SUB_TYPE_HERO_WALL, SceneBookLogic.SUB_TYPE_DEFEND].includes(configData.sub_type)) && !hasReward) {\r\n            const levelList = logic.getLvList(itemId);\r\n            for (const level of levelList) {\r\n                const bookconfig = gm.config.get_row_data(\"BookConfigData\", level.toString()) as BookConfig;\r\n                hasReward = 0 < bookconfig.reward;\r\n                if (hasReward && logic.checkIsUnlock(level) && gm.data.mapCell_data.checkBookItemHaveUnlockReward(level)) {\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n\r\n        const colorIndex = isUnlock ? configData.color : 0;\r\n        this.color_bgs.forEach((bg, index) => {\r\n            bg.active = index == colorIndex;\r\n        });\r\n\r\n        Utils.async_set_sprite_frame(this.icon, BundleName.COMMON, `res/handbook/${configData.icon}`);\r\n        this.icon.node.opacity = isUnlock ? 255 : 171;\r\n        this.icon.node.color = isUnlock ? cc.Color.WHITE : cc.Color.BLACK;\r\n        this.icon_reward.node.parent.active = hasReward;\r\n        this.icon_reward.node.scale = 0.6;\r\n\r\n        if (hasReward) {\r\n            this.icon_reward.node.active = isHeroType;\r\n            if (this.icon_reward.node.active) {\r\n                Utils.async_set_sprite_frame(this.icon_reward, BundleName.COMMON, `res/handbook/${configData.reward}`);\r\n            }\r\n        }\r\n\r\n        this.delayShow(delayCd);\r\n    }\r\n\r\n    private delayShow(delay: number): void {\r\n        cc.Tween.stopAllByTarget(this.node_root);\r\n        if (delay <= 0) {\r\n            this.node_root.opacity = 255;\r\n        } else {\r\n            this.node_root.opacity = 0;\r\n            cc.tween(this.node_root).delay(delay).to(0.42, { opacity: 255 }).start();\r\n        }\r\n    }\r\n\r\n    private setScale(scale: number): void {\r\n        this.iScale = scale;\r\n        this.node.scale = this.iScale;\r\n    }\r\n\r\n    private checkGainReward(): boolean {\r\n        if (!this.icon_reward.node.active) return false;\r\n\r\n        const configData = gm.config.get_row_data(\"BookConfigData\", this.iItemId.toString()) as BookConfig;\r\n        if (gm.data.mapCell_data.checkBookItemHaveUnlockReward(this.iItemId)) {\r\n            if (configData.reward == RewardIdEnum.DIAMOND) {\r\n                gm.data.mapCell_data.setAddGameDiamond(SetItemNumEnum.ADD_ITEM_TYPE, configData.num);\r\n                gm.ui.show_coin_fly(RewardIdEnum.DIAMOND, this.node.convertToWorldSpaceAR(cc.Vec3.ZERO));\r\n            } else if (configData.reward == RewardIdEnum.GOLD) {\r\n                gm.data.mapCell_data.setAddGameCoin(SetItemNumEnum.ADD_ITEM_TYPE, configData.num);\r\n                gm.ui.show_coin_fly(RewardIdEnum.GOLD, this.node.convertToWorldSpaceAR(cc.Vec3.ZERO));\r\n            }\r\n            gm.data.mapCell_data.setBookItemGainUnlockReward(this.iItemId);\r\n            this.icon_reward.node.parent.active = false;\r\n            this.icon_reward.node.active = false;\r\n            gm.ui.get_module(gm.const.BOOK).getLogic().refreshRed();\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n\r\n    protected editor_on_button_click_handler(event: cc.Event.EventTouch, customData = null): void {\r\n        console.log(\"NodeBookItem->editor_on_button_click_handler:\", this.iItemId);\r\n        if (!this.checkGainReward() && this.iItemId > 0) {\r\n            const configData = gm.config.get_row_data(\"BookConfigData\", this.iItemId.toString()) as BookConfig;\r\n            const logic = gm.ui.get_module(gm.const.BOOK).getLogic();\r\n            if ([SceneBookLogic.SUB_TYPE_HERO, SceneBookLogic.SUB_TYPE_DEFEND, SceneBookLogic.SUB_TYPE_SUPER_HERO].includes(configData.sub_type)) {\r\n                const levelList = logic.getLvList(this.iItemId);\r\n                gm.ui.set_module_args(gm.const.BOOK_HERO_DETAIL.key, levelList);\r\n                gm.ui.show_panel(gm.const.BOOK_HERO_DETAIL);\r\n            } else if (configData.sub_type == SceneBookLogic.SUB_TYPE_HERO_WALL) {\r\n                gm.ui.set_module_args(gm.const.BOOK_HERO_DETAIL.key, [this.iItemId]);\r\n                gm.ui.show_panel(gm.const.BOOK_HERO_DETAIL);\r\n            } else {\r\n                const levelList = logic.getLvList(this.iItemId);\r\n                gm.ui.set_module_args(gm.const.BOOK_ITEM_DETAIL.key, levelList);\r\n                gm.ui.show_panel(gm.const.BOOK_ITEM_DETAIL);\r\n            }\r\n        }\r\n    }\r\n\r\n    public reset(): void {\r\n        cc.Tween.stopAllByTarget(this.node_root);\r\n        this.iItemId = 0;\r\n        this.node_root.opacity = 255;\r\n        this.node_empty.active = true;\r\n        this.node_root.active = false;\r\n        this.setScale(1);\r\n    }\r\n\r\n    protected onDisable(): void { }\r\n}\r\n\r\nexport default NodeBookItem;"]}